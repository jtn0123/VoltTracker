<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Volt Efficiency Tracker</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <!-- Leaflet.js for maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- Flatpickr date picker -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <!-- Socket.IO for real-time updates -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <!-- PWA Support -->
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#27ae60">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="/static/icons/icon-192.png">
</head>
<body>
    <!-- Header -->
    <header class="header" role="banner">
        <h1>Volt Efficiency Tracker</h1>
        <div class="header-actions">
            <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme" aria-label="Toggle dark/light theme" aria-pressed="true">
                <span class="theme-icon" id="theme-icon" aria-hidden="true">ðŸŒ™</span>
            </button>
            <div class="export-dropdown">
                <button class="export-btn" onclick="toggleExportMenu()" aria-haspopup="menu" aria-expanded="false" aria-controls="export-menu" id="export-btn">
                    Export â–¾
                </button>
                <div class="export-menu" id="export-menu" role="menu" aria-labelledby="export-btn">
                    <a href="/api/export/trips" download="trips.csv" role="menuitem">Trips (CSV)</a>
                    <a href="/api/export/trips?format=json" download="trips.json" role="menuitem">Trips (JSON)</a>
                    <a href="/api/export/fuel" download="fuel_events.csv" role="menuitem">Fuel Events (CSV)</a>
                    <a href="/api/export/all" download="volttracker_backup.json" role="menuitem">Full Backup (JSON)</a>
                    <hr style="margin: 0.5rem 0; border-color: var(--border-color);">
                    <a href="/api/export/torque-pids" download="volt_pids_complete.csv" role="menuitem">Torque PIDs (CSV)</a>
                </div>
            </div>
            <div class="status-indicator" role="status" aria-live="polite">
                <span class="status-dot" id="status-dot" aria-hidden="true"></span>
                <span id="last-sync">Loading...</span>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container">
        <!-- Live Trip Section (hidden by default, shown when trip is active) -->
        <section id="live-trip-section" class="card card-live" style="display:none;" role="region" aria-label="Live trip data">
            <h2>Live Trip</h2>
            <div id="live-trip-content">
                <!-- Populated by JavaScript -->
            </div>
        </section>

        <!-- Power Flow Section (hidden by default, shown when live data has power flow info) -->
        <section id="power-flow-section" class="card card-power-flow" style="display:none;" role="region" aria-label="Power flow visualization">
            <h2>Power Flow</h2>
            <div class="power-flow-container">
                <!-- Power Flow Diagram -->
                <div class="power-flow-diagram">
                    <div class="power-source" id="power-battery">
                        <div class="power-label">Battery</div>
                        <div class="power-bar-container">
                            <div class="power-bar" id="battery-bar"></div>
                        </div>
                        <div class="power-stats" id="battery-stats">-- V, -- A</div>
                    </div>
                    <div class="power-arrow" id="power-direction">
                        <span class="arrow-icon">â†’</span>
                    </div>
                    <div class="power-dest" id="power-motor">
                        <div class="power-label">Motor</div>
                        <div class="power-value" id="power-kw">-- kW</div>
                        <div class="power-mode" id="power-mode">--</div>
                    </div>
                    <div class="power-arrow">
                        <span class="arrow-icon">â†’</span>
                    </div>
                    <div class="power-dest">
                        <div class="power-label">Wheels</div>
                    </div>
                </div>

                <!-- Motor/Generator Stats -->
                <div class="powertrain-stats">
                    <div class="powertrain-row">
                        <div class="powertrain-item">
                            <span class="powertrain-label">Motor A</span>
                            <span class="powertrain-value" id="motor-a-rpm">-- RPM</span>
                        </div>
                        <div class="powertrain-item">
                            <span class="powertrain-label">Motor B</span>
                            <span class="powertrain-value" id="motor-b-rpm">-- RPM</span>
                        </div>
                    </div>
                    <div class="powertrain-row">
                        <div class="powertrain-item">
                            <span class="powertrain-label">Generator</span>
                            <span class="powertrain-value" id="generator-rpm">-- RPM</span>
                        </div>
                        <div class="powertrain-item">
                            <span class="powertrain-label">Engine</span>
                            <span class="powertrain-value" id="engine-status">--</span>
                        </div>
                    </div>
                    <div class="powertrain-row" id="motor-temps-row" style="display:none;">
                        <div class="powertrain-item powertrain-temps">
                            <span class="powertrain-label">Motor Temps</span>
                            <span class="powertrain-value" id="motor-temps">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Summary Cards -->
        <section id="summary-section" class="cards-grid" aria-label="Gas efficiency summary">
            <div class="card" role="region" aria-labelledby="lifetime-mpg-label">
                <div class="card-label" id="lifetime-mpg-label">Lifetime Gas MPG</div>
                <div class="card-value" id="lifetime-mpg" aria-live="polite">--</div>
                <div class="card-subtitle" id="lifetime-miles">Loading...</div>
            </div>
            <div class="card" role="region" aria-labelledby="tank-mpg-label">
                <div class="card-label" id="tank-mpg-label">Current Tank MPG</div>
                <div class="card-value" id="tank-mpg" aria-live="polite">--</div>
                <div class="card-subtitle" id="tank-miles">Loading...</div>
            </div>
            <div class="card" role="region" aria-labelledby="soc-floor-label">
                <div class="card-label" id="soc-floor-label">Avg SOC Floor</div>
                <div class="card-value" id="soc-floor" aria-live="polite">--</div>
                <div class="card-subtitle" id="soc-count">Loading...</div>
            </div>
            <div class="card" role="region" aria-labelledby="total-miles-label">
                <div class="card-label" id="total-miles-label">Total Miles Tracked</div>
                <div class="card-value" id="total-miles" aria-live="polite">--</div>
                <div class="card-subtitle">All trips</div>
            </div>
        </section>

        <!-- Electric Efficiency Cards -->
        <section class="cards-grid electric-cards" aria-label="Electric efficiency summary">
            <div class="card card-electric" role="region" aria-labelledby="kwh-per-mile-label">
                <div class="card-label" id="kwh-per-mile-label">Electric Efficiency</div>
                <div class="card-value" id="kwh-per-mile" aria-live="polite">--</div>
                <div class="card-subtitle" id="mi-per-kwh">Loading...</div>
            </div>
            <div class="card card-electric" role="region" aria-labelledby="electric-miles-label">
                <div class="card-label" id="electric-miles-label">Electric Miles</div>
                <div class="card-value" id="total-electric-miles" aria-live="polite">--</div>
                <div class="card-subtitle" id="total-kwh-used">Loading...</div>
            </div>
            <div class="card card-electric" role="region" aria-labelledby="total-kwh-label">
                <div class="card-label" id="total-kwh-label">Total kWh Charged</div>
                <div class="card-value" id="total-kwh" aria-live="polite">--</div>
                <div class="card-subtitle" id="charging-sessions">Loading...</div>
            </div>
            <div class="card card-electric" role="region" aria-labelledby="ev-ratio-label">
                <div class="card-label" id="ev-ratio-label">EV Ratio</div>
                <div class="card-value" id="ev-ratio" aria-live="polite">--</div>
                <div class="card-subtitle">Electric vs Gas miles</div>
            </div>
        </section>

        <!-- Battery Health Card (hidden until data exists) -->
        <section id="battery-health-section" class="battery-health-section" style="display:none;" aria-labelledby="battery-health-title">
            <div class="card card-battery-health" role="region" aria-labelledby="battery-health-title">
                <div class="battery-health-header">
                    <h3 id="battery-health-title">Battery Health</h3>
                    <span class="battery-health-status" id="battery-health-status">--</span>
                </div>
                <div class="battery-health-visual">
                    <div class="battery-health-bar-container">
                        <div class="battery-health-bar" id="battery-health-bar"></div>
                    </div>
                </div>
                <div class="battery-health-stats">
                    <div class="battery-health-main">
                        <span class="battery-health-value" id="battery-health-capacity">--</span>
                        <span class="battery-health-original">/ <span id="battery-health-original">18.4</span> kWh</span>
                    </div>
                    <div class="battery-health-percent" id="battery-health-percent">--% capacity</div>
                    <div class="battery-health-trend" id="battery-health-trend"></div>
                </div>
            </div>
        </section>

        <!-- MPG Trend Chart -->
        <section class="chart-section" aria-labelledby="mpg-chart-title">
            <div class="chart-header">
                <h2 class="chart-title" id="mpg-chart-title">Gas MPG Trend</h2>
                <div class="timeframe-selector" role="group" aria-label="Chart timeframe">
                    <button class="timeframe-btn" data-days="7" onclick="setTimeframe(7)" aria-pressed="false">7 Days</button>
                    <button class="timeframe-btn active" data-days="30" onclick="setTimeframe(30)" aria-pressed="true">30 Days</button>
                    <button class="timeframe-btn" data-days="90" onclick="setTimeframe(90)" aria-pressed="false">90 Days</button>
                    <button class="timeframe-btn" data-days="365" onclick="setTimeframe(365)" aria-pressed="false">All Time</button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="mpg-chart" role="img" aria-label="MPG trend chart showing fuel efficiency over time"></canvas>
            </div>
        </section>

        <!-- Recent Trips -->
        <section id="trips-section" class="trips-section" aria-labelledby="trips-title">
            <div class="section-header">
                <h2 class="section-title" id="trips-title">Recent Trips</h2>
                <div class="date-filter">
                    <label for="date-range" class="visually-hidden">Filter trips by date range</label>
                    <input type="text" id="date-range" placeholder="Filter by date range" readonly aria-label="Filter by date range">
                    <button class="btn-clear-filter" id="clear-date-filter" onclick="clearDateFilter()" style="display: none;" aria-label="Clear date filter">Clear</button>
                </div>
            </div>

            <!-- Desktop Table -->
            <div class="trips-table-wrapper">
                <table class="trips-table" aria-label="Recent trips">
                    <thead>
                        <tr>
                            <th scope="col">Date</th>
                            <th scope="col">Total</th>
                            <th scope="col">Electric</th>
                            <th scope="col">Gas</th>
                            <th scope="col">MPG</th>
                            <th scope="col">SOC at Switch</th>
                            <th scope="col"><span class="visually-hidden">Actions</span></th>
                        </tr>
                    </thead>
                    <tbody id="trips-table-body" aria-live="polite">
                        <tr>
                            <td colspan="7">
                                <div class="loading" role="status" aria-label="Loading trips">
                                    <div class="spinner" aria-hidden="true"></div>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Mobile Cards -->
            <div class="trip-cards" id="trip-cards" role="list" aria-label="Recent trips" aria-live="polite">
                <div class="loading" role="status" aria-label="Loading trips">
                    <div class="spinner" aria-hidden="true"></div>
                </div>
            </div>
        </section>

        <!-- SOC Analysis -->
        <section id="soc-section" class="soc-section" aria-labelledby="soc-analysis-title">
            <div class="soc-stats" role="region" aria-labelledby="soc-analysis-title">
                <h2 class="section-title" id="soc-analysis-title">SOC Floor Analysis</h2>
                <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.875rem;">
                    Battery state of charge when the engine starts. Higher values over time may indicate battery degradation.
                </p>
                <dl class="stat-list">
                    <div class="stat-row">
                        <dt class="stat-label">Average SOC</dt>
                        <dd class="stat-value" id="soc-avg" aria-live="polite">--</dd>
                    </div>
                    <div class="stat-row">
                        <dt class="stat-label">Minimum SOC</dt>
                        <dd class="stat-value" id="soc-min" aria-live="polite">--</dd>
                    </div>
                    <div class="stat-row">
                        <dt class="stat-label">Maximum SOC</dt>
                        <dd class="stat-value" id="soc-max" aria-live="polite">--</dd>
                    </div>
                    <div class="stat-row">
                        <dt class="stat-label">Cold Weather (&lt;50Â°F)</dt>
                        <dd class="stat-value" id="soc-cold" aria-live="polite">--</dd>
                    </div>
                    <div class="stat-row">
                        <dt class="stat-label">Warm Weather (â‰¥50Â°F)</dt>
                        <dd class="stat-value" id="soc-warm" aria-live="polite">--</dd>
                    </div>
                    <div class="stat-row">
                        <dt class="stat-label">Trend</dt>
                        <dd class="stat-value" id="soc-trend" aria-live="polite">--</dd>
                    </div>
                </dl>
            </div>
            <div class="soc-histogram" role="region" aria-labelledby="soc-histogram-title">
                <h2 class="section-title" id="soc-histogram-title">SOC Distribution</h2>
                <div class="chart-container" style="height: 200px;">
                    <canvas id="soc-histogram-chart" role="img" aria-label="Histogram showing SOC distribution when engine starts"></canvas>
                </div>
            </div>
        </section>

        <!-- Charging History -->
        <section id="charging-section" class="charging-section" aria-labelledby="charging-title">
            <div class="section-header">
                <h2 class="section-title" id="charging-title">Charging History</h2>
                <button class="btn-add" onclick="openAddChargingModal()" aria-label="Add new charging session">+ Add Session</button>
            </div>
            <div class="charging-stats-row">
                <div class="charging-stats" role="region" aria-label="Charging session counts">
                    <dl class="stat-list">
                        <div class="stat-row">
                            <dt class="stat-label">L1 Sessions</dt>
                            <dd class="stat-value" id="l1-sessions" aria-live="polite">--</dd>
                        </div>
                        <div class="stat-row">
                            <dt class="stat-label">L2 Sessions</dt>
                            <dd class="stat-value" id="l2-sessions" aria-live="polite">--</dd>
                        </div>
                    </dl>
                </div>
                <!-- Cost Comparison (hidden until data exists) -->
                <div id="cost-comparison-section" class="cost-comparison" style="display:none;" role="region" aria-label="Cost comparison">
                    <h4>Cost per Mile</h4>
                    <div class="cost-compare-grid">
                        <div class="cost-item electric">
                            <span class="cost-label">Electric</span>
                            <span class="cost-value" id="cost-per-mile-electric">--</span>
                        </div>
                        <div class="cost-item gas">
                            <span class="cost-label">Gas</span>
                            <span class="cost-value" id="cost-per-mile-gas">--</span>
                        </div>
                    </div>
                    <div class="cost-savings" id="cost-savings">--</div>
                </div>
            </div>
            <div class="charging-table-wrapper">
                <table class="charging-table" aria-label="Charging sessions">
                    <thead>
                        <tr>
                            <th scope="col">Date</th>
                            <th scope="col">Type</th>
                            <th scope="col">kWh</th>
                            <th scope="col">SOC</th>
                            <th scope="col">Duration</th>
                            <th scope="col">Location</th>
                            <th scope="col"><span class="visually-hidden">Actions</span></th>
                        </tr>
                    </thead>
                    <tbody id="charging-table-body" aria-live="polite">
                        <tr>
                            <td colspan="7">
                                <div class="loading" role="status" aria-label="Loading charging sessions">
                                    <div class="spinner" aria-hidden="true"></div>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Import Section -->
        <section class="import-section" aria-labelledby="import-title">
            <div class="section-header">
                <h2 class="section-title" id="import-title">Import Data</h2>
            </div>
            <div class="import-form" role="region" aria-label="Import Torque CSV logs">
                <p class="import-description">Import historical data from Torque Pro CSV log files.</p>
                <form id="import-form" onsubmit="handleImport(event)" aria-label="CSV import form">
                    <div class="import-controls">
                        <label for="csv-file" class="btn-secondary btn-file">
                            Choose CSV File
                            <input type="file" id="csv-file" accept=".csv" required hidden>
                        </label>
                        <span id="file-name" class="file-name" aria-live="polite">No file selected</span>
                        <button type="submit" class="btn-primary" id="import-btn" disabled>Import</button>
                    </div>
                </form>
                <div id="import-status" class="import-status" role="status" aria-live="polite"></div>
            </div>
        </section>
    </main>

    <!-- Trip Detail Modal -->
    <div class="modal" id="trip-modal" role="dialog" aria-modal="true" aria-labelledby="trip-modal-title" aria-hidden="true">
        <div class="modal-backdrop" onclick="closeTripModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="trip-modal-title">Trip Details</h2>
                <button class="modal-close" onclick="closeTripModal()" aria-label="Close trip details">&times;</button>
            </div>
            <div class="modal-body">
                <div class="trip-detail-summary" id="trip-detail-summary" role="region" aria-label="Trip statistics">
                    <!-- Summary stats injected here -->
                </div>
                <div class="trip-detail-map" id="trip-detail-map" role="img" aria-label="Trip route map">
                    <!-- Leaflet map goes here -->
                </div>
                <div class="trip-detail-charts" role="region" aria-label="Trip charts">
                    <div class="chart-container" style="height: 200px;">
                        <canvas id="trip-speed-chart" role="img" aria-label="Speed over time chart"></canvas>
                    </div>
                    <div class="chart-container" style="height: 200px;">
                        <canvas id="trip-soc-chart" role="img" aria-label="Battery state of charge over time chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charging Session Detail Modal -->
    <div class="modal" id="charging-detail-modal" role="dialog" aria-modal="true" aria-labelledby="charging-detail-title" aria-hidden="true">
        <div class="modal-backdrop" onclick="closeChargingDetailModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="charging-detail-title">Charging Session Details</h2>
                <button class="modal-close" onclick="closeChargingDetailModal()" aria-label="Close session details">&times;</button>
            </div>
            <div class="modal-body">
                <div class="charging-detail-summary" id="charging-detail-summary" role="region" aria-label="Charging statistics">
                    <!-- Summary stats injected here -->
                </div>
                <div class="charging-curve-container" role="region" aria-label="Charging curve chart">
                    <h3>Power & SOC Over Time</h3>
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="charging-curve-chart" role="img" aria-label="Charging power and SOC over time"></canvas>
                    </div>
                </div>
                <div class="charging-cost-breakdown" id="charging-cost-breakdown" role="region" aria-label="Cost breakdown">
                    <!-- Cost breakdown injected here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Add Charging Session Modal -->
    <div class="modal" id="charging-modal" role="dialog" aria-modal="true" aria-labelledby="charging-modal-title" aria-hidden="true">
        <div class="modal-backdrop" onclick="closeChargingModal()"></div>
        <div class="modal-content modal-form">
            <div class="modal-header">
                <h2 id="charging-modal-title">Add Charging Session</h2>
                <button class="modal-close" onclick="closeChargingModal()" aria-label="Close charging form">&times;</button>
            </div>
            <div class="modal-body">
                <form id="charging-form" onsubmit="submitChargingSession(event)" aria-label="Add charging session form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="charge-start">Start Time</label>
                            <input type="datetime-local" id="charge-start" required aria-required="true">
                        </div>
                        <div class="form-group">
                            <label for="charge-end">End Time</label>
                            <input type="datetime-local" id="charge-end">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="charge-start-soc">Start SOC (%)</label>
                            <input type="number" id="charge-start-soc" min="0" max="100" step="1" aria-describedby="soc-hint">
                        </div>
                        <div class="form-group">
                            <label for="charge-end-soc">End SOC (%)</label>
                            <input type="number" id="charge-end-soc" min="0" max="100" step="1">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="charge-kwh">kWh Added</label>
                            <input type="number" id="charge-kwh" min="0" max="20" step="0.1">
                        </div>
                        <div class="form-group">
                            <label for="charge-type">Charge Type</label>
                            <select id="charge-type">
                                <option value="">Select...</option>
                                <option value="L1">L1 (120V)</option>
                                <option value="L2">L2 (240V)</option>
                                <option value="DCFC">DC Fast Charge</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="charge-cost">Cost ($)</label>
                            <input type="number" id="charge-cost" min="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label for="charge-location">Location</label>
                            <input type="text" id="charge-location" placeholder="Home, Work, etc.">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="charge-notes">Notes</label>
                        <textarea id="charge-notes" rows="2" placeholder="Optional notes..."></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn-secondary" onclick="closeChargingModal()">Cancel</button>
                        <button type="submit" class="btn-primary">Save Session</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation (Mobile) -->
    <nav class="bottom-nav" aria-label="Main navigation">
        <a href="#summary-section" class="bottom-nav-item active" data-section="summary">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="7" height="7" rx="1"/>
                <rect x="14" y="3" width="7" height="7" rx="1"/>
                <rect x="3" y="14" width="7" height="7" rx="1"/>
                <rect x="14" y="14" width="7" height="7" rx="1"/>
            </svg>
            <span>Summary</span>
        </a>
        <a href="#trips-section" class="bottom-nav-item" data-section="trips">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                <path d="M2 17l10 5 10-5"/>
                <path d="M2 12l10 5 10-5"/>
            </svg>
            <span>Trips</span>
        </a>
        <a href="#charging-section" class="bottom-nav-item" data-section="charging">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
            </svg>
            <span>Charging</span>
        </a>
        <a href="#soc-section" class="bottom-nav-item" data-section="analysis">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 3v18h18"/>
                <path d="M18 9l-5 5-4-4-3 3"/>
            </svg>
            <span>Analysis</span>
        </a>
    </nav>

    <script src="/static/js/dashboard.js"></script>
</body>
</html>
